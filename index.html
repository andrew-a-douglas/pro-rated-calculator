<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro-Rated Refund Calculator</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #121a2b;
      --muted: #7b89a7;
      --text: #e9eef8;
      --accent: #5dd6ff;
      --ok: #7ee787;
      --warn: #ffb86b;
      --err: #ff6b6b;
      --ring: #2b88ff55;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 800px at 10% -10%, #1a2340 0%, var(--bg) 40%) fixed;
    }
    .wrap { max-width: 980px; margin: 40px auto; padding: 24px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0)); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); padding: 20px; backdrop-filter: blur(6px); }
    h1 { margin: 0 0 16px; letter-spacing: 0.2px; font-size: 28px; }
    p.desc { color: var(--muted); margin-top: 0; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .col-6 { grid-column: span 6; }
    .col-12 { grid-column: span 12; }

    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="date"], input[type="number"] { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); background: var(--panel); color: var(--text); outline: none; transition: box-shadow .15s ease, border-color .15s ease, transform .1s ease; }
    input:focus { box-shadow: 0 0 0 6px var(--ring); border-color: #2b88ff; }
    /* Make calendar button icon more visible */
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(80%) sepia(60%) saturate(400%) hue-rotate(180deg); cursor: pointer; }

    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

    .muted { color: var(--muted); }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #101828; border: 1px solid rgba(255,255,255,0.07); font-size: 12px; color: var(--muted); }

    .out { margin-top: 12px; display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .stat { grid-column: span 3; background: var(--panel); border: 1px solid rgba(255,255,255,0.06); padding: 14px; border-radius: 12px; }
    .stat h3 { margin: 0; font-size: 13px; color: var(--muted); font-weight: 600; }
    .stat .val { margin-top: 6px; font-size: 20px; letter-spacing: .3px; }

    .big { grid-column: span 12; background: linear-gradient(180deg, rgba(93,214,255,0.08), rgba(93,214,255,0.02)); border: 1px solid rgba(93,214,255,0.35); border-radius: 14px; padding: 18px; }
    .big h2 { margin: 0; font-size: 24px; letter-spacing: .2px; }
    .big .val { font-size: 36px; font-weight: 800; margin-top: 6px; }

    .actions { display: flex; gap: 12px; align-items: center; }
    .actions .spacer { flex: 1 1 auto; }

    .copy-btn { padding: 6px 12px; border-radius: 8px; background: var(--accent); color: #000; font-weight: 600; border: none; cursor: pointer; transition: background .2s ease, opacity .2s ease; }
    .copy-btn:hover { background: #9ae6ff; }
    .copy-btn:disabled { opacity: .5; cursor: not-allowed; }

    .help { margin-top: 18px; font-size: 13px; color: var(--muted); }
    .foot { margin-top: 22px; font-size: 12px; color: var(--muted); }

    @media (max-width: 860px) { .col-6 { grid-column: span 12; } .stat { grid-column: span 6; } }
    @media (max-width: 520px) { .stat { grid-column: span 12; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Pro-Rated Refund Calculator</h1>
      <p class="desc">Enter the original price, total service duration, and the date range of access. The calculator refunds the unused portion: <span class="pill">refund = price × (remaining_days ÷ total_duration)</span></p>

      <div class="grid" id="form">
        <div class="col-6">
          <label for="refDate">Reference Date (start of access)</label>
          <input type="date" id="refDate" />
        </div>
        <div class="col-6">
          <label for="endDate">Date of End of Service</label>
          <input type="date" id="endDate" />
        </div>
        <div class="col-6">
          <label for="price">Price (total paid)</label>
          <input type="number" id="price" inputmode="decimal" placeholder="0.00" step="0.01" min="0" />
        </div>
        <div class="col-6">
          <label for="duration">Duration (days)</label>
          <input type="number" id="duration" inputmode="numeric" placeholder="e.g., 365" step="1" min="1" />
        </div>
      </div>

      <div class="out" id="out">
        <div class="stat"><h3>Days Used</h3><div class="val" id="daysUsed">—</div></div>
        <div class="stat"><h3>Days Remaining</h3><div class="val" id="daysLeft">—</div></div>
        <div class="stat"><h3>% Used</h3><div class="val" id="pctUsed">—</div></div>
        <div class="stat"><h3>% Remaining</h3><div class="val" id="pctLeft">—</div></div>
        <div class="big">
          <div class="actions">
            <h2>Pro-Rated Refund</h2>
            <span class="pill" id="note">Clamped between $0 and full price</span>
            <span class="spacer"></span>
            <button type="button" class="copy-btn" id="copyBtn" disabled>Copy</button>
          </div>
          <div class="val" id="refund">—</div>
        </div>
      </div>

      <div class="help">
        <strong>How it works.</strong> We compute <em>days_used</em> as the day difference between the two date inputs (UTC, midnight-to-midnight), clamped to <code>[0, duration]</code>. Then:
        <div class="pill">remaining_days = max(0, duration − days_used)</div>
        <div class="pill">refund = price × (remaining_days ÷ duration)</div>
      </div>

      <div class="foot">Edge cases are handled: if End Date is before Reference Date, usage is treated as 0; if usage exceeds Duration, it is capped at Duration. All results round to 2 decimals.</div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const fields = ['refDate','endDate','price','duration'].map($);

    function parseDate(d) {
      if (!d) return null;
      const t = new Date(d);
      return Number.isNaN(t.getTime()) ? null : t;
    }

    function daysBetweenUTC(a, b) {
      const toUTCDateOnly = (dt) => new Date(Date.UTC(dt.getUTCFullYear(), dt.getUTCMonth(), dt.getUTCDate()));
      const A = toUTCDateOnly(a);
      const B = toUTCDateOnly(b);
      const diffMs = B - A;
      return Math.floor(diffMs / 86400000);
    }

    function currency(n) { return isFinite(n) ? n.toLocaleString(undefined, { style: 'currency', currency: 'USD' }) : '—'; }
    function pct(n) { return isFinite(n) ? (n*100).toFixed(2).replace(/\.00$/, '') + '%' : '—'; }

    let lastRefundNumber = NaN; // raw number, 2-dec rounded

    function compute() {
      const price = parseFloat($('price').value);
      const duration = parseInt($('duration').value, 10);
      const ref = parseDate($('refDate').value);
      const end = parseDate($('endDate').value);

      if (!Number.isFinite(price) || price < 0 || !Number.isFinite(duration) || duration <= 0 || !ref || !end) {
        $('daysUsed').textContent = '—';
        $('daysLeft').textContent = '—';
        $('pctUsed').textContent = '—';
        $('pctLeft').textContent = '—';
        $('refund').textContent = '—';
        $('note').textContent = 'Enter all inputs to calculate';
        $('copyBtn').disabled = true;
        lastRefundNumber = NaN;
        return;
      }

      let used = daysBetweenUTC(ref, end);
      if (used < 0) used = 0; // End before Reference → 0 used
      if (used > duration) used = duration; // cap at total duration

      const remaining = Math.max(0, duration - used);
      const refundRaw = Math.max(0, Math.min(price, price * (remaining / duration)));
      const refundRounded = Math.round(refundRaw * 100) / 100; // 2-dec

      lastRefundNumber = refundRounded;

      $('daysUsed').textContent = used.toString();
      $('daysLeft').textContent = remaining.toString();
      $('pctUsed').textContent = pct(used / duration);
      $('pctLeft').textContent = pct(remaining / duration);
      $('refund').textContent = currency(refundRounded);

      let note = 'Clamped between $0 and full price';
      if (used === 0) note = 'No usage detected (End before/at Reference)';
      if (used === duration) note = 'Full usage reached';
      $('note').textContent = note;

      $('copyBtn').disabled = !isFinite(lastRefundNumber);
    }

    async function copyRefund() {
      if (!isFinite(lastRefundNumber)) return;
      const text = lastRefundNumber.toFixed(2); // numeric only
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          // Fallback for non-secure contexts
          const ta = document.createElement('textarea');
          ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
          document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        }
        const btn = $('copyBtn');
        const old = btn.textContent; btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = old, 1200);
      } catch (e) {
        const btn = $('copyBtn');
        const old = btn.textContent; btn.textContent = 'Copy failed';
        setTimeout(() => btn.textContent = old, 1400);
      }
    }

    $('copyBtn').addEventListener('click', copyRefund);
    fields.forEach(el => el.addEventListener('input', compute));

    (function seed() {
      const today = new Date();
      const iso = (d) => d.toISOString().slice(0,10);
      $('refDate').value = iso(new Date(today.getFullYear(), today.getMonth(), 1));
      $('endDate').value = iso(today);
      $('price').value = '100.00';
      $('duration').value = '365';
      compute();
    })();
  </script>
</body>
</html>
